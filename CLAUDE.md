# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Что это

Плагин для Claude Code, реализующий 7-фазный воркфлоу разработки доработок в существующих конфигурациях 1С:Предприятие. Адаптация [feature-dev](https://github.com/anthropics/claude-plugins-official/tree/main/plugins/feature-dev) от Anthropic для платформы 1С.

## Архитектура

Плагин состоит из трёх слоёв:

1. **Скиллы** (`skills/*/SKILL.md`) — команды, доступные пользователю:
   - `1c-feature-dev` — основной воркфлоу из 7 фаз (Discovery -> Исследование -> Уточняющие вопросы -> Архитектура -> Реализация -> Проверка качества -> Итоги). Оркестрирует агентов и управляет переходами между фазами.
   - `1c-query-optimization` — продвинутые паттерны оптимизации запросов 1С: временные таблицы, соединения vs подзапросы, параметры виртуальных таблиц, `ВЫРАЗИТЬ` для составных типов, `ПРЕДСТАВЛЕНИЕ`, `ОБЪЕДИНИТЬ ВСЕ`, выравнивание по индексам. Основан на стандартах ИТС.

2. **Агенты** (`agents/*.md`) — специализированные субагенты, запускаемые параллельно (обычно по 3) на ключевых фазах:
   - `1c-code-explorer` (Phase 2) — трассировка существующего кода, анализ паттернов
   - `1c-code-architect` (Phase 4) — проектирование архитектуры с разными компромиссами
   - `1c-code-writer` (Phase 5, 6) — написание и исправление кода по плану
   - `1c-code-reviewer` (Phase 6) — ревью с confidence-based filtering (порог >= 75)

3. **Правила** (`rules/*.md`) — загружаются автоматически при установке плагина:
   - `1c-rules.md` — стандарты кодирования 1С (читаются агентами `1c-code-writer` и `1c-code-reviewer`)
   - `1c-ssl.md` — правила работы с БСП: всегда проверять наличие готового решения в БСП перед написанием кода, ключевые модули БСП
   - `mcp-requirements.md` — контракт MCP-зависимостей: категории возможностей (навигация, анализ кода, валидация, справка), поведение при недоступности, правила для агентов

## Ключевые потоки данных

- Phase 0 проверяет доступность обязательных MCP-серверов до начала работы (fail-fast)
- Агенты возвращают списки ключевых файлов — основной агент обязан их прочитать для построения контекста
- Phase 4 создаёт файл плана `.tasks/task-[name]/plan.md` — Phase 5 и 6 работают по этому плану
- Phase 6 итеративна: ревью -> исправление -> повторное ревью, пока нет критических проблем
- Каждая фаза требует явного одобрения пользователя перед переходом к следующей
- Агенты используют MCP по категориям возможностей, не привязываясь к конкретным именам tools (см. `mcp-requirements.md`)

## Правила кодирования 1С (из rules/1c-rules.md)

- Области модулей: `ПрограммныйИнтерфейс` (public), `СлужебныйПрограммныйИнтерфейс` (private), `СлужебныеПроцедурыИФункции` (protected)
- Запросы: формат `Запрос = Новый Запрос;` с текстом на новой строке; всегда псевдонимы через `КАК`; промежуточная переменная `РезультатЗапроса`; не использовать запросы в цикле
- Не использовать `Сообщить()` — вместо него `ОбщегоНазначения.СообщитьПользователю` (сервер) / `ОбщегоНазначенияКлиент.СообщитьПользователю` (клиент)
- Не получать реквизиты через точку от ссылки — использовать `ОбщегоНазначения.ЗначениеРеквизитаОбъекта` / `ЗначениеРеквизитовОбъекта` / `ЗначениеРеквизитаОбъектов`
- Проверять экспортные методы в общих модулях и модулях менеджеров для переиспользования
- Ограничение строки 120 символов; без тернарных операторов; без венгерской нотации
- Не использовать имена из глобального контекста 1С для переменных (Документы, Справочники, Регистры, Метаданные, Константы и др.)
- В формах: минимизировать переходы клиент-сервер; предпочитать `&НаСервереБезКонтекста`; предпочитать `Асинх` вместо `ОписаниеОповещения`
- Кешировать повторяющиеся вычисления в цикле через Соответствие
- Проверять конкурентность и корректность блокировок/транзакций

## Установка

Через маркетплейс (рекомендуется):
```bash
/plugin marketplace add Diversus23/1c-feature-dev
/plugin install 1c-feature-dev
```

Вручную:
```bash
cp agents/*.md ~/.claude/agents/
cp -r skills/* ~/.claude/skills/
cp rules/*.md ~/.claude/rules/
```

## Требования

- Конфигурация 1С, выгруженная в файлы 1C:EDT
- [EDT MCP Server](https://github.com/DitriXNew/EDT-MCP) — справка 1С, проверка синтаксиса, поиск по БСП и метаданным (устанавливается отдельно)
- [mcp-bsl-platform-context](https://github.com/alkoleft/mcp-bsl-platform-context) — контекст платформы BSL: типы, методы, свойства глобального контекста (устанавливается отдельно)
